<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ - ØªØ§Ú©Ø³ÛŒ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: white;
            min-height: 100vh;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .header {
            background: #128C7E;
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .controls {
            padding: 15px;
            background: white;
            border-top: 2px solid #128C7E;
        }
        
        .location-info {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
        }
        
        button {
            width: 100%;
            padding: 12px;
            background: #128C7E;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 5px;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .instruction {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            background: rgba(255,255,255,0.95);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="page-title">ğŸ“ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡</h1>
            <p id="instruction">Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÙˆÙ‚Ø¹ÛŒØªØŒ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</p>
        </div>
        
        <div class="map-container">
            <div class="instruction" id="instruction-box">
                âœ¨ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø§Ù†ØªØ®Ø§Ø¨ Ø´ÙˆØ¯
            </div>
            <div id="map"></div>
        </div>
        
        <div class="controls">
            <div class="location-info">
                <strong>Ù…ÙˆÙ‚Ø¹ÛŒØª Ø§Ù†ØªØ®Ø§Ø¨ÛŒ:</strong>
                <div id="selected-address">Ù‡Ù†ÙˆØ² Ù…ÙˆÙ‚Ø¹ÛŒØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡</div>
                <div id="selected-coords" style="font-size: 12px; color: #666;"></div>
            </div>
            <button onclick="confirmSelection()" id="confirm-btn" disabled>âœ… ØªØ§ÛŒÛŒØ¯ Ù…ÙˆÙ‚Ø¹ÛŒØª</button>
            <button onclick="cancelSelection()" style="background: #dc3545; margin-top: 8px;">âŒ Ø§Ù†ØµØ±Ø§Ù</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ global
        let map;
        let selectedMarker = null;
        let selectedLatLng = null;
        let selectedAddress = "Ù‡Ù†ÙˆØ² Ù…ÙˆÙ‚Ø¹ÛŒØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡";
        
        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù†Ù‚Ø´Ù‡
        function initMap() {
            // Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù‚Ø´Ù‡
            map = L.map('map').setView([35.7036, 51.3515], 15);
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù„Ø§ÛŒÙ‡ Ù†Ù‚Ø´Ù‡
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
            
            // Ø±ÙˆÛŒØ¯Ø§Ø¯ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡
            map.on('click', function(e) {
                selectLocation(e.latlng);
            });
        }
        
        // Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡
        function selectLocation(latlng) {
            // Ø­Ø°Ù marker Ù‚Ø¨Ù„ÛŒ
            if (selectedMarker) {
                map.removeLayer(selectedMarker);
            }
            
            // Ø§ÛŒØ¬Ø§Ø¯ marker Ø¬Ø¯ÛŒØ¯
            selectedMarker = L.marker(latlng).addTo(map)
                .bindPopup('ğŸ“ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø´Ù…Ø§')
                .openPopup();
            
            selectedLatLng = latlng;
            
            // Ù†Ù…Ø§ÛŒØ´ Ù…Ø®ØªØµØ§Øª
            document.getElementById('selected-coords').textContent = 
                `Ø¹Ø±Ø¶: ${latlng.lat.toFixed(6)}, Ø·ÙˆÙ„: ${latlng.lng.toFixed(6)}`;
            
            // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ ØªØ§ÛŒÛŒØ¯
            document.getElementById('confirm-btn').disabled = false;
            
            // Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø¯Ø±Ø³
            getAddressFromCoords(latlng.lat, latlng.lng);
        }
        
        // Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø¯Ø±Ø³ Ø§Ø² Ù…Ø®ØªØµØ§Øª
        function getAddressFromCoords(lat, lng) {
            document.getElementById('selected-address').textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø¯Ø±Ø³...';
            
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=fa`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.display_name) {
                        selectedAddress = data.display_name;
                        // Ø®Ù„Ø§ØµÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¢Ø¯Ø±Ø³
                        const addressParts = selectedAddress.split(',').slice(0, 4).join(', ');
                        document.getElementById('selected-address').textContent = addressParts;
                    } else {
                        selectedAddress = `Ù…ÙˆÙ‚Ø¹ÛŒØª Ø§Ù†ØªØ®Ø§Ø¨ÛŒ (${lat.toFixed(4)}, ${lng.toFixed(4)})`;
                        document.getElementById('selected-address').textContent = selectedAddress;
                    }
                })
                .catch(error => {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø¯Ø±Ø³:', error);
                    selectedAddress = `Ù…ÙˆÙ‚Ø¹ÛŒØª Ø§Ù†ØªØ®Ø§Ø¨ÛŒ (${lat.toFixed(4)}, ${lng.toFixed(4)})`;
                    document.getElementById('selected-address').textContent = selectedAddress;
                });
        }
        
        // ØªØ§ÛŒÛŒØ¯ Ø§Ù†ØªØ®Ø§Ø¨
        function confirmSelection() {
            if (selectedLatLng) {
                // Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡ Ø¨Ù‡ Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…
                if (window.Telegram && window.Telegram.WebApp) {
                    const data = {
                        lat: selectedLatLng.lat,
                        lng: selectedLatLng.lng,
                        address: selectedAddress
                    };
                    window.Telegram.WebApp.sendData(JSON.stringify(data));
                    window.Telegram.WebApp.close();
                } else {
                    // Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø±
                    alert(`Ù…ÙˆÙ‚Ø¹ÛŒØª Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯:\n${selectedAddress}\n(${selectedLatLng.lat}, ${selectedLatLng.lng})`);
                }
            }
        }
        
        // Ø§Ù†ØµØ±Ø§Ù
        function cancelSelection() {
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.close();
            } else {
                alert('Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯');
            }
        }
        
        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ÙˆÙ‚ØªÛŒ ØµÙØ­Ù‡ Ù„ÙˆØ¯ Ø´Ø¯
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            
            // ØªÙ†Ø¸ÛŒÙ… Ø­Ø§Ù„Øª Telegram Web App
            if (window.Telegram && window.Telegram.WebApp) {
                Telegram.WebApp.expand();
                Telegram.WebApp.enableClosingConfirmation();
                
                // ØªÙ†Ø¸ÛŒÙ… instruction Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ Ù…ÙˆÙ‚Ø¹ÛŒØª
                const urlParams = new URLSearchParams(window.location.search);
                const type = urlParams.get('type');
                if (type === 'pickup') {
                    document.getElementById('page-title').textContent = 'ğŸ“ Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¨Ø¯Ø§ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡';
                    document.getElementById('instruction').textContent = 'Ù…Ø¨Ø¯Ø§ Ø³ÙØ± Ø±Ø§ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯';
                    document.getElementById('instruction-box').textContent = 'âœ¨ Ù…Ø¨Ø¯Ø§ Ø³ÙØ± Ø±Ø§ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯';
                } else if (type === 'destination') {
                    document.getElementById('page-title').textContent = 'ğŸ¯ Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ù‚ØµØ¯ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡';
                    document.getElementById('instruction').textContent = 'Ù…Ù‚ØµØ¯ Ø³ÙØ± Ø±Ø§ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯';
                    document.getElementById('instruction-box').textContent = 'âœ¨ Ù…Ù‚ØµØ¯ Ø³ÙØ± Ø±Ø§ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯';
                }
            }
        });
    </script>
</body>
</html>